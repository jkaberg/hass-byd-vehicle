name: Create Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out default branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Update manifest version
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          manifest_path = Path("custom_components/byd_vehicle/manifest.json")
          data = json.loads(manifest_path.read_text(encoding="utf-8"))
          data["version"] = str(__import__("os").environ["VERSION"])
          manifest_path.write_text(
              json.dumps(data, indent=2, ensure_ascii=True) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Commit manifest version
        run: |
          if git diff --quiet; then
            echo "No manifest changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add custom_components/byd_vehicle/manifest.json
          git commit -m "Bump manifest version to ${{ github.ref_name }}"
          git push

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
